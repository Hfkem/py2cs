## 第七章：馬爾可夫鏈蒙特卡羅

## 什麼是馬爾可夫鏈蒙特卡羅？

馬爾可夫鏈蒙特卡羅（Markov chain Monte Carlo, MCMC）是一種從複雜的機率分布中提取樣本的方法。它是基於馬可夫鏈的想法，通過模擬機率分布的隨機漫步，在一定的時間內產生一組樣本，從而近似該分布的樣本。

MCMC 在機率分布的推斷中非常重要，在統計模型中特別是貝葉斯統計中得到了廣泛的應用。通過構建馬可夫鏈，從而得到樣本的方法，是 MCMC 中最重要的一個步驟。

## 馬可夫鏈

馬可夫鏈是一種隨機過程，它的狀態在時間上依賴於前一個狀態。一個具有狀態空間 S 的馬可夫鏈是指一個序列 X1, X2, X3, ...，其中每個 X_i 都屬於集合 S，而且對於任意的 i 和 j，有

$$
P(X_{i+1} = j | X_1 = x_1, X_2 = x_2, ... X_i = x_i) = P(X_{i+1} = j | X_i = x_i)
$$

換句話說，過程在某個時刻轉移到某一狀態的概率只與當前的狀態有關，而與之前的狀態無關。這種無記憶性質稱為馬可夫性質。如下圖所示，狀態 S_1 轉移到 S_2、S_3 的概率都只與當前狀態有關，不受之前的狀態影響。 

![image.png](attachment:image.png)

馬可夫鏈的轉移過程可以用轉移矩陣 Q 來描述。如果狀態空間 S 中有 n 個狀態，轉移矩陣 Q 是一個 n x n 的矩陣，其中 Q_{i,j} 表示從狀態 i 轉移到狀態 j 的概率。使得所有狀態的轉移概率之和等於 1，即

$\sum\limits_{j=1}^{n}Q_{i,j}=1$

馬可夫鏈的某個狀態 X_t 之後若干時間的狀態 X_{t+k} 的概率，可以通過轉移矩陣 Q 的 k 次冪 Q^k 來計算：

$P(X_{t+k} = j | X_t = i) = (Q^k)_{i,j}$

如果 Q 的任意冪都是可逆的，那麼 Q 就是一個可逆的馬可夫鏈，可逆的馬可夫鏈有一個平衡分佈，表示經過足夠長時間後，狀態過程的分佈達到一個穩定的狀態，該穩定狀態是狀態轉移矩陣的一個 eigenvector。

## 馬爾可夫鏈蒙特卡羅

在機率分布的推斷中，我們常常希望從一個複雜的機率分布 p(x) 中提取一些樣本。如果可以非常容易地找到這個分布的概率密度函數，例如正態分布，就可以使用從該分布中生成的隨機數來產生樣本，但在很多情況下，這是不可能的。

MCMC 是解決這個問題的方法之一，主要思想是通過模拟馬可夫鏈隨機漫步的方式產生樣本。由於馬可夫鏈具有無記憶性質，因此沿著馬可夫鏈走的任意一條路徑就是由一個狀態出發，通過隨機漫步得到的一系列狀態，這個序列可以近似地代表著機率分布。如果狀態轉移矩陣是符合該分佈的，那麼通過 MCMC 可以得到逼近分佈的樣本。

一個基本的 MCMC 算法，如 Metropolis-Hastings，根據當前狀態和該狀態下的機率密度函數，通過一個隨機過程來產生下一個狀態。這個隨機過程稱為轉移過程，通常使用提議分佈 proposal distribution $q(x_t, x_{t+1})$。然後比較新提議的狀態和原狀態下的機率密度函數值的比例，根據 Metropolis-Hastings 演算法，決定是否接受新的狀態。演算法步驟如下：

1. 從當前狀態 $x_t$ 中產生一個提議狀態 $y$，也就是從提議分佈 $q(x_t,y)$ 中進行抽樣。
2. 計算接受概率 $\alpha(x_t,y)$ ，根據下式求得： $\alpha(x_t,y) = min\left(1, \frac{p(y)q(y,x_t)}{p(x_t)q(x_t,y)}\right)$
3. 接受提議狀態 $y_t$，如果一個隨機數 $u$ 滿足 $u \le \alpha(x_t,y)$，否則保持當前狀態 $x_t$。

在 Metropolis-Hastings 演算法的過程中，提議分佈是可控的，通常需要選擇和目標機率分佈相對應的提議分佈，才能將目標分佈收斂到穩定的狀態。

## Python 實現

Python 提供了相關的庫，如 numpy、scipy 和 pymc3，可以實現 MCMC 算法。以下是一個使用 pymc3 更簡單的例子，詳情請見 https://docs.pymc.io/。

首先，我們使用 pymc3 生成一個從正態分佈中隨機取樣的數據集，該分佈具有均值為 5 和標準差為 1：

```python
import pymc3 as pm
import numpy as np

np.random.seed(42)
data = np.random.randn(1000) + 5
```

然後，我們可以寫一個 pymc3 模型，將均值和標準差設定為模型參數，並根據數據集和先驗分佈定義概率密度函數：

```python
with pm.Model():
    mu = pm.Normal('mu', mu=0, sd=10)
    sigma = pm.HalfNormal('sigma', 5)
    obs = pm.Normal('obs', mu=mu, sd=sigma, observed=data)

    trace = pm.sample(10000, tune=1000)
```

最後，我們可以運行 traceplot 函數，查看模型輸出的散點圖：

```python
pm.traceplot(trace)
```

該散點圖顯示了均值和標準差的樣本分佈，以及數據集的直方圖。通過該散點圖，我們可以了解機率分布的隨機漫步情況，從而得到該分佈的樣本。